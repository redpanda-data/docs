= Configure Client Connections
:description: Learn about guidelines for configuring client connections in Redpanda clusters for optimal availability.
:page-categories: Management, Networking
// tag::single-source[]

Optimize the availability of your clusters by configuring and tuning properties.

== Limit client connections

A malicious Kafka client application may create many network connections to execute its attacks. A poorly configured application may also create an excessive number of connections. To mitigate the risk of a client creating too many connections and using too many system resources, you can configure a Redpanda cluster to impose limits on the number of created client connections.

The following Redpanda cluster properties limit the number of connections:

* xref:reference:properties/cluster-properties.adoc#kafka_connections_max_per_ip[`kafka_connections_max_per_ip`]: Similar to Kafka's `max.connections.per.ip`, this sets the maximum number of connections accepted per IP address by a broker.
* xref:reference:properties/cluster-properties.adoc#kafka_connections_max_overrides[`kafka_connections_max_overrides`]: A list of IP addresses for which `kafka_connections_max_per_ip` is overridden and doesn't apply.
ifndef::env-cloud[]
* xref:reference:properties/cluster-properties.adoc#kafka_connections_max[`kafka_connections_max`]: Similar to Kafka's `max.connections`, this sets the maximum number of connections per broker.

Redpanda also provides properties to manage the rate of connection creation:

* xref:reference:properties/cluster-properties.adoc#kafka_connection_rate_limit[`kafka_connection_rate_limit`]: This property limits the maximum rate of connections created per second. It applies to each CPU core.
* xref:reference:properties/cluster-properties.adoc#kafka_connection_rate_limit_overrides[`kafka_connection_rate_limit_overrides`]: A list of IP addresses for which `kafka_connection_rate_limit` is overridden and doesn't apply.
endif::[]

[NOTE]
====
* These connection limit properties are disabled by default. You must manually enable them.
* Typically, a client opens two or three connections, so the total number of connections is not equal to the number of clients. For example, to support 100 clients, you might set your connection limit to 300.
====

ifdef::env-cloud[]
=== Configure connection count limit by client IP

Use the `kafka_connections_max_per_ip` property to limit the number of connections from each client IP address. 

IMPORTANT: Per-IP connection controls require Redpanda to see individual client IPs. If clients connect through PrivateLink endpoints, NAT gateways, or other shared-IP egress, the per-IP limit applies to the shared IP, affecting all clients behind it and preventing isolation of a single offending client.

==== Configure the limit

To configure `kafka_connections_max_per_ip` safely without disrupting legitimate clients, follow these steps:

. Set up metrics scraping into your monitoring stack for the relevant cluster. See xref:manage:monitor-cloud.adoc[].

. Monitor current connection patterns using the `redpanda_rpc_active_connections` metric with the `redpanda_server="kafka"` filter:
+
```
redpanda_rpc_active_connections{redpanda_id="CLOUD_CLUSTER_ID", redpanda_server="kafka"}
```

. Analyze the connection data to identify the normal range of connections per IP address during typical traffic cycles.

. Set the `kafka_connections_max_per_ip` value based on your analysis: 
** Use the upper bound of normal connections from step 3, OR
** Use a lower value if you know the expected connections per client (typically 2-3 connections per client)

. Continue monitoring the connection metrics after applying the limit to ensure:
** Legitimate clients are not affected
** The problematic client is properly controlled

==== Limitations

* Decreasing the limit does not terminate any currently open Kafka API connections.
* This limit does not apply to Kafka HTTP Proxy connections.
* The limit may negatively affect tail latencies across all client connections.
* Clients behind NAT gateways or private links share the same IP address as seen by Redpanda brokers.
* All clients behind the shared IP are collectively subject to the single `kafka_connections_max_per_ip` limit.
* Connection rejections occur randomly among clients once the limit is reached. For example: If `kafka_connections_max_per_ip` is set to 100, but clients behind a NAT gateway collectively need 150 connections, whichever client attempts the 101st connection gets rejected.
* Redpanda may modify this property during internal operations.
* Availability incidents caused by misconfiguring this feature are excluded from the Redpanda Cloud SLA.

endif::env-cloud[]

== Configure client reconnections

You can configure the Kafka client backoff and retry properties to change the default behavior of the clients to suit your failure requirements.

Set the following Kafka client properties on your application's producer or consumer to manage client reconnections:

* `reconnect.backoff.ms`: Amount of time to wait before attempting to reconnect to the broker. The default is 50 milliseconds.
* `reconnect.backoff.max.ms`: Maximum amount of time in milliseconds to wait when reconnecting to a broker. The backoff increases exponentially for each consecutive connection failure, up to this maximum. The default is 1000 milliseconds (1 second).

Additionally, you can use Kafka properties to control message retry behavior. Delivery fails when either the delivery timeout or the number of retries is met.

* `delivery.timeout.ms`: Amount of time for message delivery, so messages are not retried forever. The default is 120000 milliseconds (2 minutes).
* `retries`: Number of times a producer can retry sending a message before marking it as failed. The default value is 2147483647 for Kafka >= 2.1, or 0 for Kafka \<= 2.0.
* `retry.backoff.ms`: Amount of time to wait before attempting to retry a failed request to a given topic partition. The default is 100 milliseconds.

See also: xref:develop:produce-data/configure-producers.adoc[Configure Producers]

// end::single-source[]
