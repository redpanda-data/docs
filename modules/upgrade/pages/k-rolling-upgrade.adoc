= Upgrade Redpanda in Kubernetes
:description: To benefit from Redpanda's new features and enhancements, upgrade to the latest version.
:page-aliases: manage:kubernetes/rolling-upgrade.adoc
:page-categories: Upgrades
:env-kubernetes: true

To benefit from Redpanda's new features and enhancements, upgrade to the latest version. New features are available after all brokers in the cluster are upgraded and restarted.

include::upgrade:partial$versioning.adoc[]

include::upgrade:partial$rolling-upgrades/upgrade-limitations.adoc[]

== Prerequisites

* xref:deploy:redpanda/kubernetes/index.adoc[A Redpanda cluster running in Kubernetes].
* The default xref:reference:k-redpanda-helm-spec.adoc#statefulset-updatestrategy-type[RollingUpdate strategy] configured in the Helm values.

include::upgrade:partial$incompat-changes.adoc[]

include::upgrade:partial$rolling-upgrades/restart-impact.adoc[leveloffset=+1]

== Check your current Redpanda version

Before you perform a rolling upgrade:

- Find the Redpanda version that you are currently running.
+
To find your current version of Redpanda, use xref:reference:rpk/rpk-redpanda/rpk-redpanda-admin-brokers-list.adoc[`rpk redpanda admin brokers list`]:
+
```bash
kubectl exec <pod-name> --namespace <namespace> -c redpanda -- \
  rpk redpanda admin brokers list
```
+
.Expected output:
[%collapsible]
====
The Redpanda version for each broker is listed under `VERSION`.
[role="no-copy",subs="attributes+"]
```
ID  VERSION
0   {latest-redpanda-tag}
1   {latest-redpanda-tag}
2   {latest-redpanda-tag}
```
====
- xref:upgrade:k-compatibility.adoc[Review the Kubernetes compatibility matrix] to find out if you need to upgrade the Helm chart or the Redpanda Operator to use your chosen version of Redpanda.
+
If your current version of Redpanda is more than one feature release behind the one to which you want to upgrade, you must first upgrade to an intermediate version of Redpanda.
- Learn what's changed since your original version.
+
To find information about what has changed between Redpanda versions, check the https://github.com/redpanda-data/redpanda/releases[release notes^].

== Check license status

If you use xref:get-started:licensing/overview.adoc#self-managed[enterprise features] of Redpanda, make sure that you have a valid Enterprise Edition license key. From version 24.3, Redpanda fails to upgrade to a new feature release if you have enterprise features enabled without a valid license key.

include::get-started:partial$licensing/check-license.adoc[]

== Prepare your cluster

Before you upgrade, you must make sure that your cluster is in a healthy state and that your topics are configured to limit outages during the upgrade process.

. Check for topics that have a replication factor greater than one.
+
If you have topics with a replication factor of 1, and if you have sufficient disk space, temporarily xref:manage:data-migration.adoc#change-topic-replication-factor[increase the replication factor] to limit outages for these topics during the rolling upgrade.
+
Increase the replication factor before you upgrade to ensure that Redpanda has time to replicate data to other brokers.

. Ensure that the cluster is healthy:
+
```bash
kubectl exec <pod-name> --namespace <namespace> -c redpanda -- \
  rpk cluster health
```
+
The draining process won't start until the cluster is healthy.
+
.Example output:
[%collapsible]
====
[.no-copy]
----
CLUSTER HEALTH OVERVIEW
=======================
Healthy:                     true <1>
Controller ID:               0
All nodes:                   [0 1 2] <2>
Nodes down:                  [] <3>
Leaderless partitions:       [] <3>
Under-replicated partitions: [] <3>
----
<1> The cluster is either healthy (`true`) or unhealthy (`false`).
<2> The node IDs of all brokers in the cluster.
<3> These fields contain data only when the cluster is unhealthy.
====

[[upgrade]]
== Perform a rolling upgrade

Performing a rolling upgrade allows you to update the version of Redpanda without downtime. This process ensures that each broker is sequentially updated and restarted, minimizing the impact on your environment.

The upgrade process depends on your deployment method:

- **Redpanda Operator**: Update the Redpanda custom resource to specify a new Helm chart version or Redpanda image tag. The operator manages the upgrade process.
- **Helm**: Either upgrade to a newer version of the Redpanda Helm chart (recommended) or update the Redpanda image tag in your existing Helm release. Upgrading the chart is preferred because it ensures that any new configuration parameters are included.

Upgrading a Redpanda cluster in Kubernetes triggers a sequential restart of the Pods managed by the StatefulSet. During each broker's restart, the following steps occur:

- The `preStop` lifecycle hook is executed to place the broker into maintenance mode. This step ensures that the broker stops accepting new connections and finishes processing its current tasks.
- Kubernetes then terminates the Pod. If the broker does not shut down within the allowed grace period (default 90 seconds), Kubernetes forcefully terminates it using a `SIGKILL` signal.
- After the Pod is terminated, the `postStart` lifecycle hook is executed to take the broker out of maintenance mode, allowing it to rejoin the cluster once restarted.

[tabs]
======
Operator::
+
--

. xref:upgrade:k-compatibility.adoc[Review the Kubernetes compatibility matrix] and https://github.com/redpanda-data/redpanda-operator/releases[review the Redpanda Operator release notes^] to determine the version of the Redpanda Operator that is compatible with the Helm chart and Redpanda version you plan to use.
+
The Redpanda Operator and Helm chart follow the same versioning scheme as Redpanda core (for example, operator version 25.1.1 deploys Redpanda 25.1 by default). Each operator version supports the corresponding Redpanda version Â±1 minor version.

. If you need to upgrade the Redpanda Operator:
+
.. Back up your current Helm values for the Redpanda Operator:
+
[source,bash]
----
helm get values redpanda-controller --namespace <namespace> > redpanda-operator-values-backup.yaml
----

.. Upgrade the Redpanda Operator to a version compatible with your target Redpanda version:
+
[source,bash]
----
helm repo add redpanda https://charts.redpanda.com
helm repo update
helm upgrade redpanda-controller redpanda/operator \
  --namespace <namespace> \
  --version <operator-version> \
  --set crds.enabled=true
----
+
Replace `<operator-version>` with the version of the Redpanda Operator you want to upgrade to.

.. Verify that the operator deployment is successfully rolled out:
+
[source,bash]
----
kubectl --namespace <namespace> rollout status --watch deployment/redpanda-controller-operator
----
+
.Expected output
[%collapsible]
====
[.no-copy]
----
deployment "redpanda-controller-operator" successfully rolled out
----
====

. Upgrade the Redpanda cluster by updating the Redpanda image tag in your Redpanda resource:
+
.`redpanda-cluster.yaml`
[source,yaml]
----
apiVersion: cluster.redpanda.com/v1alpha2
kind: Redpanda
metadata:
  name: redpanda
spec:
  clusterSpec:
    image:
      tag: <new-version> <1>
    statefulset:
      # Optional
      podTemplate:
        spec:
          terminationGracePeriodSeconds: <grace-period> <2>
----
+
<1> The version of Redpanda to deploy (for example, `v25.2.1`). The operator automatically uses the appropriate Helm chart version for the specified Redpanda version.
<2> The `statefulset.podTemplate.spec.terminationGracePeriodSeconds` setting defines how long Kubernetes will wait for the broker to shut down gracefully before forcefully terminating it. The default value is 90 seconds, which is enough for most clusters, but might require adjustment based on your workload. Modify this setting if your Redpanda brokers have high loads or hold large amounts of data, as they might need more time to shut down gracefully.

. Apply the Redpanda resource to deploy the Redpanda cluster:
+
```bash
kubectl apply -f redpanda-cluster.yaml --namespace <namespace>
```

--
Helm::
+
--

. xref:upgrade:k-compatibility.adoc[Review the Kubernetes compatibility matrix] and verify which version of the Redpanda Helm chart supports the Redpanda version you plan to upgrade to. The Helm chart version can dictate which configurations and Kubernetes resources are available or required for that specific version of Redpanda.

. Check the default Redpanda version of a chart to make sure that it uses the version that you want to upgrade your cluster to.
+
[source,bash]
----
helm show chart --version <chart-version> redpanda/redpanda | grep  "appVersion"
----
+
Replace `<chart-version>` with the version number of a newer chart.

. Back up your current Helm values for the Redpanda Helm chart:
+
[source,bash]
----
helm get values redpanda --namespace <namespace> > redpanda-values-backup.yaml
----
+
You'll need to apply these overrides in the next step.

. Optional: Update the following settings:
+
.`redpanda-version.yaml`
[,yaml]
----
image:
  tag: <new-version> <1>
statefulset:
  podTemplate:
    spec:
      terminationGracePeriodSeconds: <grace-period> <2>
----
+
<1> If you need to upgrade to an intermediate version of Redpanda, use this setting to specify the version of Redpanda to deploy. This version overrides the default one in the Helm chart. Replace `<new-version>` with a valid version tag.
<2> The `statefulset.podTemplate.spec.terminationGracePeriodSeconds` setting defines how long Kubernetes will wait for the broker to shut down gracefully before forcefully terminating it. The default value is 90 seconds, which is enough for most clusters, but might require adjustment based on your workload. Modify this setting in your Helm values file if your Redpanda brokers have high loads or hold large amounts of data, as they might need more time to shut down gracefully.

. If your current chart uses Redpanda Console v2, migrate your configuration to the new v3 format before upgrading to 25.1.x. For more information, see xref:migrate:console-v3.adoc[].

. Deploy Redpanda with the new Helm chart version:
+
```bash
helm upgrade --install redpanda redpanda/redpanda --namespace <namespace> \
  --create-namespace \
  --version <helm-chart-version> \
  --values redpanda-version.yaml
```
+
Make sure to include all existing overrides, otherwise the upgrade may fail.
For example, if you already enabled SASL, include the same SASL overrides.
+
CAUTION: Do not use the `--reuse-values` flag, otherwise Helm won't include any new values from the upgraded chart.
--
======

== Verify the upgrade

After upgrading, verify that your Redpanda cluster is functioning correctly:

. Wait for the Pods to be terminated and recreated with the new version of Redpanda.
+
[,bash]
----
kubectl get pod --namespace <namespace> --watch
----
+
Each Pod in the StatefulSet is terminated one at a time, starting from the one with the highest ordinal.
+
.Example output
[%collapsible]
====
[.no-copy]
----
NAME                                    READY   STATUS
redpanda-controller-operator            2/2     Running
redpanda-0                              2/2     Running
redpanda-1                              2/2     Running
redpanda-2                              0/2     Init:0/3
redpanda-configuration-88npt            0/1     Completed
redpanda-console-7cf85cf87f-rmtnj       1/1     Running
redpanda-post-upgrade-ljqpr             0/1     Completed
----
====

. When all of the Pods are ready and have a `Running` status, verify that the brokers are now running the upgraded version of Redpanda:
+
```bash
kubectl exec <pod-name> --namespace <namespace> -c redpanda -- \
  rpk redpanda admin brokers list
```

. If you upgraded from operator v25.1.x to v25.2.x or later, check for Console migration warnings:
+
When upgrading across this version boundary, Redpanda Console is automatically upgraded from v2 to v3. The operator attempts to migrate your Console configuration automatically. If any configuration settings cannot be migrated, warnings are added to the Console custom resource.
+
[,bash]
----
kubectl get console <console-name> --namespace <namespace> -o jsonpath='{.spec.warnings}'
----
+
If warnings are present, review them and manually update your Console configuration as needed. For details about migrating to Console v3, see xref:migrate:console-v3.adoc[].

== Roll back

If something does not go as planned during a rolling upgrade, you can roll back to the original version as long as you have not upgraded all brokers.

The StatefulSet uses the `RollingUpdate` strategy by default in xref:reference:k-redpanda-helm-spec.adoc#statefulsetupdatestrategytype[`statefulset.updateStrategy.type`],
which means all Pods in the StatefulSet are restarted in reverse-ordinal order. For details, see the https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#update-strategies[Kubernetes documentation^].

[tabs]
======
Operator::
+
--
Revert the change that you made to the version and reapply the manifest.
--
Helm::
+
--
. Find the previous revision:
+
```bash
helm history redpanda --namespace <namespace>
```
+
Example output
+
[.no-copy]
----
REVISION	UPDATED                 	STATUS    	CHART          	APP VERSION	DESCRIPTION
1       	Fri Mar  3 15:16:24 year	superseded	redpanda-2.12.2	v22.3.13   	Install complete
2       	Fri Mar  3 15:19:41 year	deployed	  redpanda-2.12.2	v22.3.13   	Upgrade complete
----

. Roll back to the previous revision:
+
```bash
helm rollback redpanda <previous-revision> --namespace <namespace>
```

. Verify that the cluster is healthy. If the cluster is unhealthy, the upgrade may still be in progress. The command exits when the cluster is healthy.
+
```bash
kubectl exec <pod-name> --namespace <namespace> -c redpanda -- \
  rpk cluster health \
  --watch --exit-when-healthy
```
+
.Example output:
[%collapsible]
====
[.no-copy]
```
CLUSTER HEALTH OVERVIEW
=======================
Healthy:               true
Controller ID:         1
All nodes:             [2,1,0]
Nodes down:            []
Leaderless partitions: []
```
====
--
======

== Troubleshooting

include::troubleshoot:partial$errors-and-solutions.adoc[tags=deployment]

include::shared:partial$suggested-reading.adoc[]

Set up a real-time dashboard to monitor your cluster health, see xref:manage:kubernetes/monitoring/index.adoc[Monitor Redpanda].
