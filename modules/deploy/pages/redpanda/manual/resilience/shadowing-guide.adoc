= Shadowing Guide
:description: Step-by-step emergency guide for failing over Redpanda shadow links during disasters.
:env-linux: true
:page-categories: Management, High Availability, Disaster Recovery, Emergency Response

[NOTE]
====
include::shared:partial$enterprise-license.adoc[]
====

This guide provides step-by-step procedures for emergency failover when your primary Redpanda cluster becomes unavailable. Follow these procedures only during active disasters when immediate failover is required.

[IMPORTANT]
====
This is an emergency procedure. For planned failover testing or day-to-day shadow link management, see xref:deploy:redpanda/manual/resilience/shadowing.adoc[]. Ensure you have completed the xref:deploy:redpanda/manual/resilience/shadowing.adoc#disaster-readiness-checklist[disaster readiness checklist] before an emergency occurs.
====

== Emergency failover procedure

Follow these steps during an active disaster:

1. <<assess-situation,Assess the situation>>
2. <<verify-shadow-status,Verify shadow cluster status>>  
3. <<document-state,Document current state>>
4. <<initiate-failover,Initiate failover>>
5. <<monitor-progress,Monitor failover progress>>
6. <<update-applications,Update application configuration>>
7. <<verify-functionality,Verify application functionality>>
8. <<cleanup-stabilize,Clean up and stabilize>>

[[assess-situation]]
=== Assess the situation

Confirm that failover is necessary:

[,bash]
----
# Check if the primary cluster is responding
rpk cluster info --brokers <primary-cluster-brokers>

# If primary cluster is down, check shadow cluster health
rpk cluster info --brokers <shadow-cluster-brokers>
----

**Decision point**: If the primary cluster is responsive, consider whether failover is actually needed. Partial outages may not require full disaster recovery.

[[verify-shadow-status]]
=== Verify shadow cluster status

Check the health of your shadow links:

[,bash]
----
# List all shadow links
rpk shadow list

# Check the configuration of your shadow link
rpk shadow describe <disaster-recovery-link-name>

# Check the status of your disaster recovery link
rpk shadow status <disaster-recovery-link-name>
----

Verify that the following conditions exist before proceeding with failover:

* Shadow link state should be `ACTIVE`.
* Topics should be in `ACTIVE` state (not `FAULTED`).
* Replication lag should be reasonable for your RPO requirements.

[[document-state]]
=== Document current state

Record the current lag and status before proceeding:

[,bash]
----
# Capture current status for post-mortem analysis
rpk shadow status <disaster-recovery-link-name> > failover-status-$(date +%Y%m%d-%H%M%S).log
----

IMPORTANT: Note the replication lag to estimate potential data loss.

[[initiate-failover]]
=== Initiate failover

A complete cluster failover is appropriate If you observe that the source cluster is no longer reachable:

[,bash]
----
# Fail over all topics in the shadow link
rpk shadow failover <disaster-recovery-link-name> --all
----

For selective topic failover (when only specific services are affected):

[,bash]
----
# Fail over individual topics
rpk shadow failover <disaster-recovery-link-name> --topic <critical-topic-1>
rpk shadow failover <disaster-recovery-link-name> --topic <critical-topic-2>
----

[[monitor-progress]]
=== Monitor failover progress

Track the failover process:

[,bash]
----
# Monitor status until all topics show FAILED_OVER
watch -n 5 "rpk shadow status <disaster-recovery-link-name>"

# Or check specific status sections during troubleshooting
rpk shadow status <disaster-recovery-link-name> --print-overview    # Basic link information
rpk shadow status <disaster-recovery-link-name> --print-topic      # Detailed topic status and lag
----

**Wait for**: All critical topics to reach `FAILED_OVER` state before proceeding.

[[update-applications]]
=== Update application configuration

Redirect your applications to the shadow cluster by updating connection strings in your applications to point to shadow cluster brokers. If using DNS-based service discovery, update DNS records accordingly. Restart applications to pick up new connection settings and verify connectivity from application hosts to shadow cluster.

[[verify-functionality]]
=== Verify application functionality

Test critical application workflows:

[,bash]
----
# Verify applications can produce messages
rpk topic produce <critical-topic> --brokers <shadow-cluster-brokers>

# Verify applications can consume messages
rpk topic consume <critical-topic> --brokers <shadow-cluster-brokers> --num 1
----

Test message production and consumption, consumer group functionality, and critical business workflows to ensure everything is working properly.

[[cleanup-stabilize]]
=== Clean up and stabilize

After all applications are running normally:

[,bash]
----
# Optional: Delete the shadow link (no longer needed)
rpk shadow delete <disaster-recovery-link-name>
----

Document the time of failover initiation and completion, applications affected and recovery times, data loss estimates based on replication lag, and issues encountered during failover.

== Troubleshoot common issues

=== Topics stuck in FAILING_OVER state

**Problem**: Topics remain in `FAILING_OVER` state for extended periods

**Solution**: Check shadow cluster logs for specific error messages and ensure sufficient cluster resources (CPU, memory, disk space) are available on the shadow cluster. Verify network connectivity between shadow cluster nodes and confirm that all shadow topic partitions have elected leaders and the controller partition is properly replicated with an active leader.

If topics remain stuck after addressing these cluster health issues and you need immediate failover, you can force delete the shadow link to failover all topics:

[,bash]
----
# Force delete the shadow link to failover all topics
rpk shadow delete <disaster-recovery-link-name> --force
----

[WARNING]
====
Force deleting a shadow link immediately fails over all topics in the link. This action is irreversible and should only be used when topics are stuck and you need immediate access to all replicated data.
====

=== Topics in FAULTED state

**Problem**: Topics show `FAULTED` state and are not replicating

**Solution**: Check for authentication issues, network connectivity problems, or source cluster unavailability. Verify that the shadow link service account still has the required permissions on the source cluster. Review shadow cluster logs for specific error messages about the faulted topics.

=== Application connection failures

**Problem**: Applications cannot connect to shadow cluster after failover

**Solution**: Verify shadow cluster broker endpoints are correct and check security group and firewall rules. Confirm authentication credentials are valid for the shadow cluster and test network connectivity from application hosts.

=== Consumer group offset issues

**Problem**: Consumers start from beginning or wrong positions

**Solution**: Verify consumer group offsets were replicated (check your filters) and use `rpk group describe <group-name>` to check offset positions. If necessary, manually reset offsets to appropriate positions.

== Recovery planning

After successful failover:

1. **Assess source cluster**: Determine root cause of the outage
2. **Plan recovery**: Decide whether to restore source cluster or promote shadow cluster permanently
3. **Data synchronization**: Plan how to synchronize any data produced during failover
4. **Fail forward**: Create a new shadow link with the failed over shadow cluster as source to maintain a DR cluster

== Post-incident actions

1. **Document the incident**: Record timeline, impact, and lessons learned
2. **Update runbooks**: Improve procedures based on what you learned
3. **Test regularly**: Schedule regular disaster recovery drills
4. **Review monitoring**: Ensure monitoring caught the issue appropriately